/*
ZeroG Plugin - Backend
*/

import { createResolvers } from './resolvers.js';
import typeDefs from './schema.js';
import Email from '../../models/email.js';
import { addAction, removeAction } from '../../utils/actionBus.js';

export const resolvers = await createResolvers();

let initialized = false;
let getAdminMenusCallback,
  getAdminPagesCallback,
  pluginActivatedCallback,
  sendNotificationsCallback;

const checkTableExists = async (connection, tableName) => {
  const result = await connection`
    SELECT EXISTS (
      SELECT 1
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      AND table_name = ${tableName}
    ) AS "exists"
  `;

  return result[0].exists;
};

const setupTables = async (connection, env) => {
  let exists = await checkTableExists(connection, 'pw_zg_forms');
  if (!exists) {
    try {
      await connection`
        CREATE TABLE "public"."pw_zg_forms" (
          "id" int4 NOT NULL GENERATED ALWAYS AS IDENTITY,
          "title" varchar(255),
          "data" text,
          "active" boolean,
          "trash" boolean
        )
      `;
      await connection.unsafe(`
        ALTER TABLE "public"."pw_zg_forms" OWNER TO ${env.DATABASE_USER};
      `);
    } catch (error) {
      console.error('Error creating pw_zg_forms:', error);
    }
  }
  exists = await checkTableExists(connection, 'pw_zg_formmeta');
  if (!exists) {
    try {
      await connection`
        CREATE TABLE "public"."pw_zg_formmeta" (
          "id" int4 NOT NULL GENERATED ALWAYS AS IDENTITY (
            INCREMENT 1
            MINVALUE 1
            MAXVALUE 2147483647
            START 1
            CACHE 1
          ),
          "form_id" int4,
          "confirmations" text,
          "notifications" text,
          "views" int4 DEFAULT 0
        );    
      `;
      await connection.unsafe(`
        ALTER TABLE "public"."pw_zg_formmeta" OWNER TO ${env.DATABASE_USER};
      `);
    } catch (error) {
      console.error('Error creating pw_zg_forms:', error);
    }
  }
  exists = await checkTableExists(connection, 'pw_zg_entry');
  if (!exists) {
    try {
      await connection`
        CREATE TABLE "public"."pw_zg_entry" (
          "id" int4 NOT NULL GENERATED ALWAYS AS IDENTITY (
            INCREMENT 1
            MINVALUE 1
            MAXVALUE 2147483647
            START 1
            CACHE 1
          ),
          "form_id" int4,
          "post_id" int4,
          "date_created" timestamp,
          "date_updated" timestamp,
          "currency" varchar(255),
          "payment_status" varchar(255),
          "payment_date" timestamp,
          "payment_amount" decimal,
          "payment_method" varchar(255),
          "transaction_id" varchar(255)
        );
      `;
      await connection.unsafe(`
        ALTER TABLE "public"."pw_zg_entry" OWNER TO ${env.DATABASE_USER};
      `);
    } catch (error) {
      console.error('Error creating pw_zg_forms:', error);
    }
  }
  exists = await checkTableExists(connection, 'pw_zg_entrymeta');
  if (!exists) {
    try {
      await connection`
        CREATE TABLE "public"."pw_zg_entrymeta" (
          "id" int4 NOT NULL GENERATED ALWAYS AS IDENTITY (
            INCREMENT 1
            MINVALUE 1
            MAXVALUE 2147483647
            START 1
            CACHE 1
          ),
          "form_id" int4,
          "entry_id" int4,
          "meta_data" text
        );
      `;
      await connection.unsafe(`
        ALTER TABLE "public"."pw_zg_entrymeta" OWNER TO ${env.DATABASE_USER};
      `);
    } catch (error) {
      console.error('Error creating pw_zg_forms:', error);
    }
  }
};

export function init() {
  if (initialized) return;

  pluginActivatedCallback = async (pluginName, connection, env) => {
    if (pluginName == 'zeroGPlugin') {
      await setupTables(connection, env);
    }
  };

  getAdminMenusCallback = async (menu) => {
    const exists = menu.some((item) => item.id === 'zero-g');
    if (!exists) {
      if (pluginConfig.menuPosition === 'plugins') {
        menu
          .find((item) => item.id == 'plugins')
          .children.push({
            id: 'zero-g',
            name: 'Zero Gravity Forms',
            slug: '/admin/zero-g',
            icon: `
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="text-gray-400 group-hover:text-white" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
              <path d="M0 0 C0.98280945 -0.00974854 1.9656189 -0.01949707 2.97821045 -0.02954102 C23.51125119 -0.19141926 43.4009476 -0.25063306 63.53515625 4.23828125 C65.37235984 4.61606051 67.20959935 4.99366512 69.046875 5.37109375 C99.00662716 11.79644464 129.33665298 24.76984515 154.53515625 42.23828125 C155.07156738 42.60775879 155.60797852 42.97723633 156.16064453 43.35791016 C177.4685526 58.09128129 197.67466972 75.65453646 213.53515625 96.23828125 C213.99776855 96.8297998 214.46038086 97.42131836 214.93701172 98.03076172 C221.76330492 106.77632512 227.90394005 115.66803399 233.40869141 125.3046875 C234.23885307 126.72967242 235.09081304 128.142012 235.95458984 129.546875 C239.53011547 135.36606857 242.61248915 141.25952375 245.41015625 147.48828125 C245.83578857 148.43356689 246.2614209 149.37885254 246.69995117 150.3527832 C259.46703134 179.16868135 268.49745218 210.47937275 268.7734375 242.1953125 C268.78323135 243.12803482 268.79302521 244.06075714 268.80311584 245.02174377 C269.40176328 316.86204428 247.13699774 383.06179574 196.53515625 435.23828125 C196.02130371 435.77791504 195.50745117 436.31754883 194.97802734 436.87353516 C187.56519803 444.65119151 179.79349771 451.54206122 171.19775391 457.98583984 C169.63439879 459.16352145 168.08991503 460.36613616 166.546875 461.5703125 C159.14477381 467.28966267 151.38611067 472.27280127 143.39257812 477.10986328 C141.77000071 478.09560892 140.15931848 479.10088111 138.55078125 480.109375 C105.54102979 500.2975422 63.91843603 512.22629458 25.21484375 512.44140625 C24.36151962 512.44842056 23.5081955 512.45543488 22.62901306 512.46266174 C19.8893397 512.48006237 17.14988285 512.48651452 14.41015625 512.48828125 C13.47174896 512.48895599 12.53334167 512.48963074 11.5664978 512.49032593 C-2.98044655 512.47372107 -17.12822704 511.88839117 -31.46484375 509.23828125 C-32.81425049 509.0047998 -32.81425049 509.0047998 -34.19091797 508.76660156 C-80.6095725 500.56785454 -124.45399469 478.96559711 -158.8046875 446.7109375 C-160.95836369 444.70906228 -163.14465358 442.80640416 -165.40234375 440.92578125 C-203.87047617 407.50659121 -229.3039069 356.43522231 -239.46484375 307.23828125 C-239.67367187 306.28308594 -239.8825 305.32789063 -240.09765625 304.34375 C-246.7330734 272.97250563 -246.4836396 236.50746732 -239.46484375 205.23828125 C-239.2234668 204.1390332 -238.98208984 203.03978516 -238.73339844 201.90722656 C-230.16569105 163.91833531 -213.96688911 127.22889986 -189.00561523 97.11132812 C-187.82013647 95.6701947 -186.65079878 94.21577239 -185.48852539 92.75585938 C-180.10022409 86.0354519 -174.38577215 79.80831317 -168.27734375 73.73828125 C-167.35679199 72.82191895 -166.43624023 71.90555664 -165.48779297 70.96142578 C-159.03414091 64.61384879 -152.45526996 58.7502883 -145.12304688 53.44775391 C-143.38593966 52.1807296 -141.68270428 50.87593588 -139.98046875 49.5625 C-104.99454832 22.83003315 -63.00138741 6.82673632 -19.46484375 1.23828125 C-18.80149017 1.15136017 -18.1381366 1.06443909 -17.4546814 0.97488403 C-11.62720524 0.26470833 -5.86729157 0.04824506 0 0 Z M-52.46484375 115.23828125 C-53.58246094 115.78226563 -54.70007813 116.32625 -55.8515625 116.88671875 C-69.28361844 123.78907801 -80.65474661 132.7895244 -91.46484375 143.23828125 C-92.76035156 144.45644531 -92.76035156 144.45644531 -94.08203125 145.69921875 C-113.32176437 164.21970951 -125.48750214 187.65469536 -132.46484375 213.23828125 C-109.19984375 213.73328125 -109.19984375 213.73328125 -85.46484375 214.23828125 C-85.46484375 226.23828125 -85.46484375 226.23828125 -88.08984375 230.05078125 C-89.53743159 231.4577554 -90.99782338 232.85158084 -92.46484375 234.23828125 C-94.0455533 235.92028416 -95.5990687 237.62563686 -97.15527344 239.33032227 C-103.72359809 246.50352757 -110.55013028 253.40583905 -117.48608398 260.22265625 C-118.13649658 260.86460937 -118.78690918 261.5065625 -119.45703125 262.16796875 C-120.32884033 263.02237549 -120.32884033 263.02237549 -121.21826172 263.89404297 C-122.57817222 265.05493985 -122.57817222 265.05493985 -122.46484375 266.23828125 C-109.92484375 266.23828125 -97.38484375 266.23828125 -84.46484375 266.23828125 C-84.46484375 270.52828125 -84.46484375 274.81828125 -84.46484375 279.23828125 C-100.96484375 279.23828125 -117.46484375 279.23828125 -134.46484375 279.23828125 C-133.79655778 285.25285502 -133.10828017 290.48335529 -131.40234375 296.17578125 C-131.0779834 297.25931885 -131.0779834 297.25931885 -130.74707031 298.36474609 C-123.40406161 321.88769466 -110.30029027 342.36825422 -93.46484375 360.23828125 C-92.92730469 360.82867187 -92.38976562 361.4190625 -91.8359375 362.02734375 C-66.32352103 389.01040077 -27.27253149 405.07380145 9.53515625 406.23828125 C10.35886719 406.27824219 11.18257812 406.31820313 12.03125 406.359375 C52.8457784 407.44181959 93.43139483 391.99544932 123.28515625 364.30078125 C133.90507476 354.20319818 142.86924491 343.73208569 150.53515625 331.23828125 C150.53515625 330.90828125 150.53515625 330.57828125 150.53515625 330.23828125 C149.40542011 330.23608141 149.40542011 330.23608141 148.25286102 330.23383713 C129.86265772 330.19666303 111.47264271 330.13750886 93.0825882 330.05437851 C84.18900785 330.01469707 75.29551459 329.98224956 66.40185547 329.96728516 C58.64329748 329.95421182 50.884932 329.92710371 43.12648249 329.88366818 C39.02460848 329.8611801 34.92297077 329.84536288 30.82102966 329.8463974 C26.94669966 329.84715159 23.07288946 329.82890206 19.19869423 329.79711342 C17.78961376 329.78871262 16.38047429 329.78679617 14.97138023 329.79247856 C-6.82036451 329.86853579 -25.19195629 322.70325382 -41.16015625 307.70703125 C-56.10463869 292.16842566 -64.23383628 271.14952435 -64.83984375 249.67578125 C-64.17443608 227.21827224 -54.32199803 208.06024379 -38.2890625 192.67578125 C-33.9774969 188.954596 -29.42780438 186.0108443 -24.46484375 183.23828125 C-23.68882812 182.77808594 -22.9128125 182.31789063 -22.11328125 181.84375 C-10.06634463 175.17562956 3.3003312 173.64064675 16.84570312 173.69238281 C18.29633169 173.68361628 19.74695065 173.67311999 21.19755554 173.66105652 C25.0787949 173.63355193 28.95971328 173.62978382 32.84103584 173.63077641 C36.91830498 173.62761622 40.99543595 173.60193449 45.07263184 173.57879639 C52.76798701 173.53846806 60.46325794 173.51795065 68.15870237 173.50482249 C76.93044456 173.48887327 85.70204499 173.45042499 94.47370434 173.41022921 C112.49414329 173.3281479 130.51456842 173.27385812 148.53515625 173.23828125 C144.23118918 161.94819899 134.76889013 152.87816344 126.53515625 144.23828125 C125.86871094 143.51898438 125.20226562 142.7996875 124.515625 142.05859375 C99.04648384 115.35620997 59.80546996 99.91428305 23.3203125 99.03515625 C-3.76443307 98.71842249 -28.01561002 103.32830503 -52.46484375 115.23828125 Z M-135.46484375 227.23828125 C-136.84847219 235.54005187 -137.73571153 242.72992054 -137.58984375 250.98828125 C-137.58082031 251.9834375 -137.57179688 252.97859375 -137.5625 254.00390625 C-137.53931029 256.41563627 -137.50668712 258.82681547 -137.46484375 261.23828125 C-132.10740368 256.81891434 -127.35709281 252.09003629 -122.65234375 246.98828125 C-117.24444145 241.17365649 -111.77988643 235.46608596 -106.08984375 229.92578125 C-104.3492368 228.50867923 -104.3492368 228.50867923 -104.46484375 227.23828125 C-114.69484375 227.23828125 -124.92484375 227.23828125 -135.46484375 227.23828125 Z " transform="translate(243.46484375,-0.23828125)"/>
              <path d="M0 0 C7.69353304 6.30901176 12.75149273 13.22430574 14.10546875 23.296875 C14.54293316 33.181206 11.72770982 41.61063679 5.75 49.5 C-2.12448421 57.5259166 -11.28647774 60.87925355 -22.3125 61.0625 C-33.39668264 60.87828696 -42.5763977 57.50089733 -50.4375 49.375 C-57.71880129 39.66045372 -58.87445321 29.01492545 -57.3125 17.1875 C-55.00140345 8.975949 -49.65672814 2.73749846 -42.37109375 -1.5390625 C-28.33925883 -8.8046261 -13.31874997 -9.40888966 0 0 Z " fill="#222222" transform="translate(406.3125,224.8125)"/>
              <path d="M0 0 C10.085625 -0.12375 10.085625 -0.12375 20.375 -0.25 C22.47665527 -0.28641602 24.57831055 -0.32283203 26.74365234 -0.36035156 C28.4410704 -0.37205244 30.13849982 -0.38224094 31.8359375 -0.390625 C32.6916333 -0.41108887 33.5473291 -0.43155273 34.42895508 -0.45263672 C41.82002763 -0.45683262 48.67865226 1.26631568 54.47265625 6.03515625 C54.99730469 6.70417969 55.52195312 7.37320313 56.0625 8.0625 C56.61035156 8.73410156 57.15820312 9.40570313 57.72265625 10.09765625 C61.08435405 15.10422148 60.67150979 21.49459569 59.57421875 27.22265625 C57.89516799 32.56883627 54.84217173 36.16964708 50 39 C47.55408084 39.717153 45.57296357 39.89498108 43 40 C47.39204907 45.84665053 52.02993501 51.35942245 56.984375 56.73828125 C62 62.36627907 62 62.36627907 62 65 C57.18682646 65.34311732 52.41196168 65.57868623 47.5859375 65.4765625 C46.7923584 65.46189941 45.9987793 65.44723633 45.18115234 65.43212891 C42.46208424 64.89342837 41.35824631 63.89462733 39.5 61.875 C38.6474077 60.26002142 37.81765158 58.63294682 37 57 C35.37439224 54.44033342 33.6090004 52.00407342 31.8125 49.5625 C31.40257812 48.93520996 30.99265625 48.30791992 30.5703125 47.66162109 C29.11761048 45.53544612 29.11761048 45.53544612 26 43 C22.37 42.67 18.74 42.34 15 42 C15 49.59 15 57.18 15 65 C10.05 65 5.1 65 0 65 C0 43.55 0 22.1 0 0 Z " fill="#222222" transform="translate(276,219)"/>
              <path d="M0 0 C17.82 0 35.64 0 54 0 C54 4.29 54 8.58 54 13 C41.46 13 28.92 13 16 13 C16 16.3 16 19.6 16 23 C27.55 23 39.1 23 51 23 C51 27.29 51 31.58 51 36 C39.12 36 27.24 36 15 36 C15 40.95 15 45.9 15 51 C28.2 51 41.4 51 55 51 C55 55.29 55 59.58 55 64 C36.85 64 18.7 64 0 64 C0 42.88 0 21.76 0 0 Z " fill="#222222" transform="translate(204,220)"/>
              <path d="M0 0 C4.37651828 3.631579 6.50750202 6.91715209 7.40625 12.54296875 C7.67110755 20.01415877 5.99845579 25.33859112 1 31 C-4.43176047 34.86667695 -10.35641841 36.63272206 -17 36 C-23.59107382 33.7995479 -27.80944644 30.99624387 -31.16015625 24.8671875 C-33.51337283 19.63538506 -33.96340011 14.38724114 -32.38671875 8.84375 C-29.99340061 3.36125911 -26.17456016 -0.07920335 -21 -3 C-13.27659658 -5.4499771 -6.82406799 -4.0110934 0 0 Z " fill="#060606" transform="translate(397,236)"/>
              <path d="M0 0 C4.25037964 -0.08081708 8.49922778 -0.14041866 12.75 -0.1875 C13.9565625 -0.21263672 15.163125 -0.23777344 16.40625 -0.26367188 C17.56640625 -0.27333984 18.7265625 -0.28300781 19.921875 -0.29296875 C20.99018555 -0.3086792 22.05849609 -0.32438965 23.15917969 -0.34057617 C26.37408997 0.04484836 27.7389142 0.70902165 30 3 C30.49763593 6.89814816 30.1949195 9.70762075 28 13 C25.28598706 14.35700647 23.15153684 14.1123861 20.1171875 14.09765625 C18.95058594 14.09443359 17.78398437 14.09121094 16.58203125 14.08789062 C15.35871094 14.07951172 14.13539063 14.07113281 12.875 14.0625 C11.64394531 14.05798828 10.41289062 14.05347656 9.14453125 14.04882812 C6.09633361 14.03701341 3.04816084 14.0190775 0 14 C0 9.38 0 4.76 0 0 Z " fill="#030303" transform="translate(291,233)"/>
              <path d="M0 0 C0 0.33 0 0.66 0 1 C-1.11375 1.185625 -1.11375 1.185625 -2.25 1.375 C-4.92029746 1.86723126 -4.92029746 1.86723126 -6.875 2.9375 C-9.80091146 4.40045573 -12.84943749 5.15177163 -16 6 C-16.33 5.34 -16.66 4.68 -17 4 C-11.01990022 0.17938069 -6.96504398 -0.11608407 0 0 Z " fill="#1F1F1F" transform="translate(388,232)"/>
              <path d="M0 0 C1.65 0 3.3 0 5 0 C4 3 4 3 2 4 C2 10.27 2 16.54 2 23 C1.34 23 0.68 23 0 23 C0 15.41 0 7.82 0 0 Z " fill="#101010" transform="translate(291,261)"/>
              <path d="M0 0 C0.66 0 1.32 0 2 0 C3.38232443 1.62626404 4.71937515 3.2925002 6 5 C5.67 5.66 5.34 6.32 5 7 C2.37812506 5.95125002 1.20628639 5.35068687 -0.25 2.875 C-0.4975 2.25625 -0.745 1.6375 -1 1 C-0.67 0.67 -0.34 0.34 0 0 Z " fill="#111111" transform="translate(323,262)"/>
              <path d="M0 0 C0 3 0 3 -2.3125 5.5625 C-5 8 -5 8 -8 10 C-6.34908222 5.70761377 -3.26245434 3.1206085 0 0 Z " fill="#D6D6D6" transform="translate(361,225)"/>
              <path d="M0 0 C0.66 0.33 1.32 0.66 2 1 C2 2.98 2 4.96 2 7 C0.68 6.67 -0.64 6.34 -2 6 C-1.34 4.02 -0.68 2.04 0 0 Z " fill="#070707" transform="translate(186,216)"/>
              <path d="M0 0 C1.32 0.66 2.64 1.32 4 2 C4 3.98 4 5.96 4 8 C3.34 7.67 2.68 7.34 2 7 C1.66666667 5.33333333 1.33333333 3.66666667 1 2 C0.34 1.67 -0.32 1.34 -1 1 C-0.67 0.67 -0.34 0.34 0 0 Z " fill="#1C1C1C" transform="translate(317,234)"/>
              </svg>
              `,
            order: 2,
            children: [
              {
                id: 'forms',
                name: 'Forms',
                slug: '/admin/zero-g',
                icon: null,
                order: 1,
                children: [],
              },
              {
                id: 'add',
                name: 'Add',
                slug: '/admin/zero-g/add',
                icon: null,
                order: 2,
                children: [],
              },
            ],
          });
      } else {
        menu.push({
          id: 'zero-g',
          name: 'Zero Gravity Forms',
          slug: '/admin/zero-g',
          icon: `
              <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" class="text-gray-400 group-hover:text-white" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg">
              <path d="M0 0 C0.98280945 -0.00974854 1.9656189 -0.01949707 2.97821045 -0.02954102 C23.51125119 -0.19141926 43.4009476 -0.25063306 63.53515625 4.23828125 C65.37235984 4.61606051 67.20959935 4.99366512 69.046875 5.37109375 C99.00662716 11.79644464 129.33665298 24.76984515 154.53515625 42.23828125 C155.07156738 42.60775879 155.60797852 42.97723633 156.16064453 43.35791016 C177.4685526 58.09128129 197.67466972 75.65453646 213.53515625 96.23828125 C213.99776855 96.8297998 214.46038086 97.42131836 214.93701172 98.03076172 C221.76330492 106.77632512 227.90394005 115.66803399 233.40869141 125.3046875 C234.23885307 126.72967242 235.09081304 128.142012 235.95458984 129.546875 C239.53011547 135.36606857 242.61248915 141.25952375 245.41015625 147.48828125 C245.83578857 148.43356689 246.2614209 149.37885254 246.69995117 150.3527832 C259.46703134 179.16868135 268.49745218 210.47937275 268.7734375 242.1953125 C268.78323135 243.12803482 268.79302521 244.06075714 268.80311584 245.02174377 C269.40176328 316.86204428 247.13699774 383.06179574 196.53515625 435.23828125 C196.02130371 435.77791504 195.50745117 436.31754883 194.97802734 436.87353516 C187.56519803 444.65119151 179.79349771 451.54206122 171.19775391 457.98583984 C169.63439879 459.16352145 168.08991503 460.36613616 166.546875 461.5703125 C159.14477381 467.28966267 151.38611067 472.27280127 143.39257812 477.10986328 C141.77000071 478.09560892 140.15931848 479.10088111 138.55078125 480.109375 C105.54102979 500.2975422 63.91843603 512.22629458 25.21484375 512.44140625 C24.36151962 512.44842056 23.5081955 512.45543488 22.62901306 512.46266174 C19.8893397 512.48006237 17.14988285 512.48651452 14.41015625 512.48828125 C13.47174896 512.48895599 12.53334167 512.48963074 11.5664978 512.49032593 C-2.98044655 512.47372107 -17.12822704 511.88839117 -31.46484375 509.23828125 C-32.81425049 509.0047998 -32.81425049 509.0047998 -34.19091797 508.76660156 C-80.6095725 500.56785454 -124.45399469 478.96559711 -158.8046875 446.7109375 C-160.95836369 444.70906228 -163.14465358 442.80640416 -165.40234375 440.92578125 C-203.87047617 407.50659121 -229.3039069 356.43522231 -239.46484375 307.23828125 C-239.67367187 306.28308594 -239.8825 305.32789063 -240.09765625 304.34375 C-246.7330734 272.97250563 -246.4836396 236.50746732 -239.46484375 205.23828125 C-239.2234668 204.1390332 -238.98208984 203.03978516 -238.73339844 201.90722656 C-230.16569105 163.91833531 -213.96688911 127.22889986 -189.00561523 97.11132812 C-187.82013647 95.6701947 -186.65079878 94.21577239 -185.48852539 92.75585938 C-180.10022409 86.0354519 -174.38577215 79.80831317 -168.27734375 73.73828125 C-167.35679199 72.82191895 -166.43624023 71.90555664 -165.48779297 70.96142578 C-159.03414091 64.61384879 -152.45526996 58.7502883 -145.12304688 53.44775391 C-143.38593966 52.1807296 -141.68270428 50.87593588 -139.98046875 49.5625 C-104.99454832 22.83003315 -63.00138741 6.82673632 -19.46484375 1.23828125 C-18.80149017 1.15136017 -18.1381366 1.06443909 -17.4546814 0.97488403 C-11.62720524 0.26470833 -5.86729157 0.04824506 0 0 Z M-52.46484375 115.23828125 C-53.58246094 115.78226563 -54.70007813 116.32625 -55.8515625 116.88671875 C-69.28361844 123.78907801 -80.65474661 132.7895244 -91.46484375 143.23828125 C-92.76035156 144.45644531 -92.76035156 144.45644531 -94.08203125 145.69921875 C-113.32176437 164.21970951 -125.48750214 187.65469536 -132.46484375 213.23828125 C-109.19984375 213.73328125 -109.19984375 213.73328125 -85.46484375 214.23828125 C-85.46484375 226.23828125 -85.46484375 226.23828125 -88.08984375 230.05078125 C-89.53743159 231.4577554 -90.99782338 232.85158084 -92.46484375 234.23828125 C-94.0455533 235.92028416 -95.5990687 237.62563686 -97.15527344 239.33032227 C-103.72359809 246.50352757 -110.55013028 253.40583905 -117.48608398 260.22265625 C-118.13649658 260.86460937 -118.78690918 261.5065625 -119.45703125 262.16796875 C-120.32884033 263.02237549 -120.32884033 263.02237549 -121.21826172 263.89404297 C-122.57817222 265.05493985 -122.57817222 265.05493985 -122.46484375 266.23828125 C-109.92484375 266.23828125 -97.38484375 266.23828125 -84.46484375 266.23828125 C-84.46484375 270.52828125 -84.46484375 274.81828125 -84.46484375 279.23828125 C-100.96484375 279.23828125 -117.46484375 279.23828125 -134.46484375 279.23828125 C-133.79655778 285.25285502 -133.10828017 290.48335529 -131.40234375 296.17578125 C-131.0779834 297.25931885 -131.0779834 297.25931885 -130.74707031 298.36474609 C-123.40406161 321.88769466 -110.30029027 342.36825422 -93.46484375 360.23828125 C-92.92730469 360.82867187 -92.38976562 361.4190625 -91.8359375 362.02734375 C-66.32352103 389.01040077 -27.27253149 405.07380145 9.53515625 406.23828125 C10.35886719 406.27824219 11.18257812 406.31820313 12.03125 406.359375 C52.8457784 407.44181959 93.43139483 391.99544932 123.28515625 364.30078125 C133.90507476 354.20319818 142.86924491 343.73208569 150.53515625 331.23828125 C150.53515625 330.90828125 150.53515625 330.57828125 150.53515625 330.23828125 C149.40542011 330.23608141 149.40542011 330.23608141 148.25286102 330.23383713 C129.86265772 330.19666303 111.47264271 330.13750886 93.0825882 330.05437851 C84.18900785 330.01469707 75.29551459 329.98224956 66.40185547 329.96728516 C58.64329748 329.95421182 50.884932 329.92710371 43.12648249 329.88366818 C39.02460848 329.8611801 34.92297077 329.84536288 30.82102966 329.8463974 C26.94669966 329.84715159 23.07288946 329.82890206 19.19869423 329.79711342 C17.78961376 329.78871262 16.38047429 329.78679617 14.97138023 329.79247856 C-6.82036451 329.86853579 -25.19195629 322.70325382 -41.16015625 307.70703125 C-56.10463869 292.16842566 -64.23383628 271.14952435 -64.83984375 249.67578125 C-64.17443608 227.21827224 -54.32199803 208.06024379 -38.2890625 192.67578125 C-33.9774969 188.954596 -29.42780438 186.0108443 -24.46484375 183.23828125 C-23.68882812 182.77808594 -22.9128125 182.31789063 -22.11328125 181.84375 C-10.06634463 175.17562956 3.3003312 173.64064675 16.84570312 173.69238281 C18.29633169 173.68361628 19.74695065 173.67311999 21.19755554 173.66105652 C25.0787949 173.63355193 28.95971328 173.62978382 32.84103584 173.63077641 C36.91830498 173.62761622 40.99543595 173.60193449 45.07263184 173.57879639 C52.76798701 173.53846806 60.46325794 173.51795065 68.15870237 173.50482249 C76.93044456 173.48887327 85.70204499 173.45042499 94.47370434 173.41022921 C112.49414329 173.3281479 130.51456842 173.27385812 148.53515625 173.23828125 C144.23118918 161.94819899 134.76889013 152.87816344 126.53515625 144.23828125 C125.86871094 143.51898438 125.20226562 142.7996875 124.515625 142.05859375 C99.04648384 115.35620997 59.80546996 99.91428305 23.3203125 99.03515625 C-3.76443307 98.71842249 -28.01561002 103.32830503 -52.46484375 115.23828125 Z M-135.46484375 227.23828125 C-136.84847219 235.54005187 -137.73571153 242.72992054 -137.58984375 250.98828125 C-137.58082031 251.9834375 -137.57179688 252.97859375 -137.5625 254.00390625 C-137.53931029 256.41563627 -137.50668712 258.82681547 -137.46484375 261.23828125 C-132.10740368 256.81891434 -127.35709281 252.09003629 -122.65234375 246.98828125 C-117.24444145 241.17365649 -111.77988643 235.46608596 -106.08984375 229.92578125 C-104.3492368 228.50867923 -104.3492368 228.50867923 -104.46484375 227.23828125 C-114.69484375 227.23828125 -124.92484375 227.23828125 -135.46484375 227.23828125 Z " transform="translate(243.46484375,-0.23828125)"/>
              <path d="M0 0 C7.69353304 6.30901176 12.75149273 13.22430574 14.10546875 23.296875 C14.54293316 33.181206 11.72770982 41.61063679 5.75 49.5 C-2.12448421 57.5259166 -11.28647774 60.87925355 -22.3125 61.0625 C-33.39668264 60.87828696 -42.5763977 57.50089733 -50.4375 49.375 C-57.71880129 39.66045372 -58.87445321 29.01492545 -57.3125 17.1875 C-55.00140345 8.975949 -49.65672814 2.73749846 -42.37109375 -1.5390625 C-28.33925883 -8.8046261 -13.31874997 -9.40888966 0 0 Z " fill="#222222" transform="translate(406.3125,224.8125)"/>
              <path d="M0 0 C10.085625 -0.12375 10.085625 -0.12375 20.375 -0.25 C22.47665527 -0.28641602 24.57831055 -0.32283203 26.74365234 -0.36035156 C28.4410704 -0.37205244 30.13849982 -0.38224094 31.8359375 -0.390625 C32.6916333 -0.41108887 33.5473291 -0.43155273 34.42895508 -0.45263672 C41.82002763 -0.45683262 48.67865226 1.26631568 54.47265625 6.03515625 C54.99730469 6.70417969 55.52195312 7.37320313 56.0625 8.0625 C56.61035156 8.73410156 57.15820312 9.40570313 57.72265625 10.09765625 C61.08435405 15.10422148 60.67150979 21.49459569 59.57421875 27.22265625 C57.89516799 32.56883627 54.84217173 36.16964708 50 39 C47.55408084 39.717153 45.57296357 39.89498108 43 40 C47.39204907 45.84665053 52.02993501 51.35942245 56.984375 56.73828125 C62 62.36627907 62 62.36627907 62 65 C57.18682646 65.34311732 52.41196168 65.57868623 47.5859375 65.4765625 C46.7923584 65.46189941 45.9987793 65.44723633 45.18115234 65.43212891 C42.46208424 64.89342837 41.35824631 63.89462733 39.5 61.875 C38.6474077 60.26002142 37.81765158 58.63294682 37 57 C35.37439224 54.44033342 33.6090004 52.00407342 31.8125 49.5625 C31.40257812 48.93520996 30.99265625 48.30791992 30.5703125 47.66162109 C29.11761048 45.53544612 29.11761048 45.53544612 26 43 C22.37 42.67 18.74 42.34 15 42 C15 49.59 15 57.18 15 65 C10.05 65 5.1 65 0 65 C0 43.55 0 22.1 0 0 Z " fill="#222222" transform="translate(276,219)"/>
              <path d="M0 0 C17.82 0 35.64 0 54 0 C54 4.29 54 8.58 54 13 C41.46 13 28.92 13 16 13 C16 16.3 16 19.6 16 23 C27.55 23 39.1 23 51 23 C51 27.29 51 31.58 51 36 C39.12 36 27.24 36 15 36 C15 40.95 15 45.9 15 51 C28.2 51 41.4 51 55 51 C55 55.29 55 59.58 55 64 C36.85 64 18.7 64 0 64 C0 42.88 0 21.76 0 0 Z " fill="#222222" transform="translate(204,220)"/>
              <path d="M0 0 C4.37651828 3.631579 6.50750202 6.91715209 7.40625 12.54296875 C7.67110755 20.01415877 5.99845579 25.33859112 1 31 C-4.43176047 34.86667695 -10.35641841 36.63272206 -17 36 C-23.59107382 33.7995479 -27.80944644 30.99624387 -31.16015625 24.8671875 C-33.51337283 19.63538506 -33.96340011 14.38724114 -32.38671875 8.84375 C-29.99340061 3.36125911 -26.17456016 -0.07920335 -21 -3 C-13.27659658 -5.4499771 -6.82406799 -4.0110934 0 0 Z " fill="#060606" transform="translate(397,236)"/>
              <path d="M0 0 C4.25037964 -0.08081708 8.49922778 -0.14041866 12.75 -0.1875 C13.9565625 -0.21263672 15.163125 -0.23777344 16.40625 -0.26367188 C17.56640625 -0.27333984 18.7265625 -0.28300781 19.921875 -0.29296875 C20.99018555 -0.3086792 22.05849609 -0.32438965 23.15917969 -0.34057617 C26.37408997 0.04484836 27.7389142 0.70902165 30 3 C30.49763593 6.89814816 30.1949195 9.70762075 28 13 C25.28598706 14.35700647 23.15153684 14.1123861 20.1171875 14.09765625 C18.95058594 14.09443359 17.78398437 14.09121094 16.58203125 14.08789062 C15.35871094 14.07951172 14.13539063 14.07113281 12.875 14.0625 C11.64394531 14.05798828 10.41289062 14.05347656 9.14453125 14.04882812 C6.09633361 14.03701341 3.04816084 14.0190775 0 14 C0 9.38 0 4.76 0 0 Z " fill="#030303" transform="translate(291,233)"/>
              <path d="M0 0 C0 0.33 0 0.66 0 1 C-1.11375 1.185625 -1.11375 1.185625 -2.25 1.375 C-4.92029746 1.86723126 -4.92029746 1.86723126 -6.875 2.9375 C-9.80091146 4.40045573 -12.84943749 5.15177163 -16 6 C-16.33 5.34 -16.66 4.68 -17 4 C-11.01990022 0.17938069 -6.96504398 -0.11608407 0 0 Z " fill="#1F1F1F" transform="translate(388,232)"/>
              <path d="M0 0 C1.65 0 3.3 0 5 0 C4 3 4 3 2 4 C2 10.27 2 16.54 2 23 C1.34 23 0.68 23 0 23 C0 15.41 0 7.82 0 0 Z " fill="#101010" transform="translate(291,261)"/>
              <path d="M0 0 C0.66 0 1.32 0 2 0 C3.38232443 1.62626404 4.71937515 3.2925002 6 5 C5.67 5.66 5.34 6.32 5 7 C2.37812506 5.95125002 1.20628639 5.35068687 -0.25 2.875 C-0.4975 2.25625 -0.745 1.6375 -1 1 C-0.67 0.67 -0.34 0.34 0 0 Z " fill="#111111" transform="translate(323,262)"/>
              <path d="M0 0 C0 3 0 3 -2.3125 5.5625 C-5 8 -5 8 -8 10 C-6.34908222 5.70761377 -3.26245434 3.1206085 0 0 Z " fill="#D6D6D6" transform="translate(361,225)"/>
              <path d="M0 0 C0.66 0.33 1.32 0.66 2 1 C2 2.98 2 4.96 2 7 C0.68 6.67 -0.64 6.34 -2 6 C-1.34 4.02 -0.68 2.04 0 0 Z " fill="#070707" transform="translate(186,216)"/>
              <path d="M0 0 C1.32 0.66 2.64 1.32 4 2 C4 3.98 4 5.96 4 8 C3.34 7.67 2.68 7.34 2 7 C1.66666667 5.33333333 1.33333333 3.66666667 1 2 C0.34 1.67 -0.32 1.34 -1 1 C-0.67 0.67 -0.34 0.34 0 0 Z " fill="#1C1C1C" transform="translate(317,234)"/>
              </svg>
              `,
          order: 2,
          children: [
            {
              id: 'forms',
              name: 'Forms',
              slug: '/admin/zero-g',
              icon: null,
              order: 1,
              children: [],
            },
            {
              id: 'add',
              name: 'Add',
              slug: '/admin/zero-g/add',
              icon: null,
              order: 2,
              children: [],
            },
          ],
        });
      }
    }
    return menu;
  };

  getAdminPagesCallback = async (adminPages) => {
    const exists = adminPages.some((item) => item.key === 'zero-g-page');
    if (!exists) {
      adminPages.push({
        key: 'zero-g-page',
        path: '/zero-g',
        index: false,
        core: false,
        element: 'ZeroGPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-add',
        path: '/zero-g/add',
        index: false,
        core: false,
        element: 'ZeroGAddPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-edit',
        path: '/zero-g/edit/:id',
        index: false,
        core: false,
        element: 'ZeroGEditPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_settings',
        path: '/zero-g/form_settings/:id',
        index: false,
        core: false,
        element: 'ZeroGFormSettingsPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_settings_confirmations',
        path: '/zero-g/form_settings/confirmations/:id',
        index: false,
        core: false,
        element: 'ZeroGFormSettingsConfirmationsPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_settings_confirmations_new',
        path: '/zero-g/form_settings/confirmations/new/:id',
        index: false,
        core: false,
        element: 'ZeroGFormSettingsConfirmationsNewPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_settings_confirmations_edit',
        path: '/zero-g/form_settings/confirmations/edit/:id/:confirmationId',
        index: false,
        core: false,
        element: 'ZeroGFormSettingsConfirmationsEditPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_settings_notifications',
        path: '/zero-g/form_settings/notifications/:id',
        index: false,
        core: false,
        element: 'ZeroGFormSettingsNotificationsPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_settings_notifications_new',
        path: '/zero-g/form_settings/notifications/new/:id',
        index: false,
        core: false,
        element: 'ZeroGFormSettingsNotificationsNewPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_settings_notifications_edit',
        path: '/zero-g/form_settings/notifications/edit/:id/:notificationId',
        index: false,
        core: false,
        element: 'ZeroGFormSettingsNotificationsEditPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_entries',
        path: '/zero-g/form_entries/:id',
        index: false,
        core: false,
        element: 'ZeroGFormEntriesPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-form_entry',
        path: '/zero-g/form_entry/:formId/:id',
        index: false,
        core: false,
        element: 'ZeroGFormEntryPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
      adminPages.push({
        key: 'zero-g-settings',
        path: '/zero-g/settings',
        index: false,
        core: false,
        element: 'ZeroGSettingsPage',
        elementLocation: 'zeroG/Pages',
        children: [],
      });
    }
    return adminPages;
  };

  sendNotificationsCallback = async (formId, notifications, content, fieldsData, context) => {
    const connection = context.sql;
    const env = context.env;
    const fields = JSON.parse(fieldsData);

    const mailer = await Email.getMailer(connection, env);

    const results = await Promise.all(
      notifications.map(async (notification) => {
        const stripHtml = (html) =>
          html
            .replace(/<[^>]+>/g, '')
            .replace(/\s+/g, ' ')
            .trim();

        if (mailer == null || mailer == false) {
          return { success: false };
        }

        const allFieldsHtml = `
          <table style="border-collapse: collapse; width: 100%;">
            <tbody>
              ${Object.entries(content)
                .map(
                  ([key, value]) => `
                  <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>${key}</strong></td>
                    <td style="border: 1px solid #ddd; padding: 8px;">${value}</td>
                  </tr>`,
                )
                .join('')}
            </tbody>
          </table>
        `.trim();

        const allFieldsText = Object.entries(content)
          .map(([key, value]) => `${key}:\n${value}`)
          .join('\n\n');

        let htmlMessage = notification.message.replace('{all_fields}', allFieldsHtml);
        let textMessage = stripHtml(htmlMessage.replace(allFieldsHtml, allFieldsText));

        Object.entries(content).forEach(([key, value]) => {
          const idRegex = new RegExp(`\\{${key}\\}`, 'g');
          htmlMessage = htmlMessage.replace(idRegex, value);
          textMessage = textMessage.replace(idRegex, value);
        });

        fields.forEach((field) => {
          const value = content[field.id] || '';
          if (field.label) {
            const labelRegex = new RegExp(`\\{${escapeRegex(field.label)}\\}`, 'g');
            htmlMessage = htmlMessage.replace(labelRegex, value);
            textMessage = textMessage.replace(labelRegex, value);
          }
        });

        function escapeRegex(string) {
          return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        let sendTo = null;
        if (notification.sendTo == 'selectField') {
          const emailFieldKey = notification.emailFieldId;
          sendTo = content[emailFieldKey];
        } else {
          sendTo = notification.sendToEmail;
        }

        const status = await mailer.sendMail({
          from: `"${notification.fromName}" <${notification.fromEmail}>`,
          to: sendTo,
          subject: notification.subject,
          text: textMessage,
          html: htmlMessage,
        });
      }),
    );
    return { success: true };
  };

  addAction('plugin_activated', 'zeroGPlugin', pluginActivatedCallback);
  addAction('get_admin_menus', 'zeroGPlugin', getAdminMenusCallback);
  addAction('get_admin_pages', 'zeroGPlugin', getAdminPagesCallback);
  addAction('send_zgform_notifications', 'zeroGPlugin', sendNotificationsCallback, {
    public: true,
  });

  initialized = true;
}

export function disable() {
  removeAction('plugin_activated', 'zeroGPlugin', pluginActivatedCallback);
  removeAction('get_admin_menus', 'zeroGPlugin', getAdminMenusCallback);
  removeAction('get_admin_pages', 'zeroGPlugin', getAdminPagesCallback);
  removeAction('send_zgform_notifications', 'zeroGPlugin', sendNotificationsCallback);

  initialized = false;
}

const pluginConfig = {
  version: '0.0.1',
  name: 'Zero G Forms',
  slug: 'zeroG',
  description: 'A plugin for creating custom forms.',
  author: 'Nick Thompson, Accent Design Ltd',
  authorUrl: 'https://www.accentdesign.co.uk',
  menuPosition: 'menu',
  resolvers,
  typeDefs,
  init: init,
  disable: disable,
  shortCodes: [
    {
      name: 'zerogform',
      path: './Plugins/zeroG/Shortcodes/Form.jsx',
    },
  ],
  src: '',
};

export default pluginConfig;

export { getAdminPagesCallback };
